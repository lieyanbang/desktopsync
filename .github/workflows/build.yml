name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Locate Visual Studio toolchain
        shell: pwsh
        run: |
          $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vsWhere)) {
            throw "vswhere.exe not found at $vsWhere"
          }
          $vsInstall = & $vsWhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vsInstall) {
            throw "Unable to locate a Visual Studio installation with C++ tools."
          }
          $vcVars = Join-Path $vsInstall 'VC\Auxiliary\Build\vcvarsall.bat'
          if (-not (Test-Path $vcVars)) {
            throw "vcvarsall.bat not found at $vcVars"
          }
          "VS_BAT=$vcVars" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build binaries
        shell: cmd
        run: |
          call "%VS_BAT%" x64 || exit /b 1
          set CL_COMMON=/std:c++20 /O2 /EHsc /DWIN32 /D_WINDOWS /DWIN64 /D_WIN32_WINNT=0x0601
          del /q *.obj 2>nul
          for %%f in (desktopsync.exe config.dll p2p.dll trayhook.dll sync.dll config.lib p2p.lib trayhook.lib sync.lib config.exp p2p.exp trayhook.exp sync.exp) do if exist %%f del %%f
          cl %CL_COMMON% /LD src\config_dll.cpp src\common.cpp /I src /Fe:config.dll Shell32.lib Shlwapi.lib Ole32.lib OleAut32.lib User32.lib Gdi32.lib || exit /b 1
          cl %CL_COMMON% /LD src\p2p_dll.cpp src\common.cpp /I src /Fe:p2p.dll Ws2_32.lib Shell32.lib || exit /b 1
          cl %CL_COMMON% /LD src\trayhook_dll.cpp src\common.cpp /I src /Fe:trayhook.dll Shell32.lib Shlwapi.lib User32.lib Gdi32.lib || exit /b 1
          cl %CL_COMMON% /c src\common.cpp /I src /Fo:ds_common.obj || exit /b 1
          cl %CL_COMMON% /LD src\sync_dll.cpp udt4\src\*.cpp ds_common.obj /I src /I udt4\src /DUDT_EXPORTS /Fe:sync.dll Ws2_32.lib Shell32.lib Shlwapi.lib User32.lib Gdi32.lib Advapi32.lib || exit /b 1
          cl %CL_COMMON% src\desktopsync_main.cpp ds_common.obj /I src /Fe:desktopsync.exe config.lib p2p.lib trayhook.lib sync.lib Ws2_32.lib Shell32.lib Shlwapi.lib Ole32.lib OleAut32.lib User32.lib Gdi32.lib Advapi32.lib || exit /b 1

      - name: Package build outputs
        shell: pwsh
        run: |
          $artifactDir = "artifacts"
          if (Test-Path $artifactDir) {
            Remove-Item -Recurse -Force $artifactDir
          }
          New-Item -ItemType Directory -Path $artifactDir | Out-Null
          $files = Get-ChildItem -Path . -File | Where-Object {
            $_.Extension -in '.exe', '.dll', '.lib', '.exp'
          }
          if (-not $files) {
            throw "No build outputs were produced."
          }
          $files | Copy-Item -Destination $artifactDir -Force
          $zipPath = "desktopsync-build.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath
          }
          Compress-Archive -Path "$artifactDir\*" -DestinationPath $zipPath

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktopsync-windows
          path: desktopsync-build.zip
